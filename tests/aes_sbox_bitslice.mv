proc AND:
  inputs: a[0:3], b[0:3]
  outputs: c[0:3]
  shares: ab[0:3]
  randoms: r[0:3], r';

  ab := a * b;      
  c   = ![ab + r]; 
  ab := a * (b>>1);
  c   = ![c + ab];
  ab := (a>>1) * b;
  c   = ![c + ab];
  c   = ![c + (r>>1)];
  ab := a * (b >> 2);
  c   = ![c + ab];
  c   = ![c + [r',r',r',r']];
end
SNI AND

proc SBOX:
  inputs: U0[0:3], U1[0:3], U2[0:3], U3[0:3], U4[0:3], U5[0:3], U6[0:3], U7[0:3]
  outputs: S0[0:3], S1[0:3], S2[0:3], S3[0:3], S4[0:3], S5[0:3], S6[0:3], S7[0:3]
  shares: 
    y14_ [0:3],
    y13_ [0:3], 
    y9_  [0:3],
    y8_  [0:3],
    t0  [0:3],
    y1_  [0:3],
    y4  [0:3],
    y12 [0:3],
    y2  [0:3],
    y5  [0:3],
    y3  [0:3],
    t1  [0:3],
    y15 [0:3],
    y20_ [0:3],
    y6  [0:3],
    y10 [0:3],
    y11 [0:3],
    y7  [0:3],
    y17 [0:3],
    y19 [0:3],
    y16 [0:3],
    y21_ [0:3],
    y18 [0:3],
    t2  [0:3],
    t3_  [0:3],
    t4_  [0:3],
    t5  [0:3],
    t6  [0:3],
    t7  [0:3],
    t8  [0:3],
    t9  [0:3],
    t10_ [0:3],
    t11_ [0:3],
    t12_ [0:3],
    t13_ [0:3],
    t14 [0:3],
    t15 [0:3],
    t16 [0:3],
    t17 [0:3],
    t18 [0:3],
    t19 [0:3],
    t20_ [0:3],
    t21_ [0:3],
    t22_ [0:3],
    t23_ [0:3],
    t24 [0:3],
    t25 [0:3],
    t26 [0:3],
    t27 [0:3],
    t28 [0:3],
    t29 [0:3],
    t30 [0:3],
    t31 [0:3],
    t32 [0:3],
    t33 [0:3],
    t34 [0:3],
    t35 [0:3],
    t36 [0:3],
    t37 [0:3],
    t38 [0:3],
    t39 [0:3],
    t40 [0:3],
    t41 [0:3],
    t42 [0:3],
    t43 [0:3],
    t44 [0:3],
    t45 [0:3],
    z0  [0:3],
    z1_  [0:3],
    z2  [0:3],
    z3  [0:3],
    z4  [0:3],
    z5  [0:3],
    z6  [0:3],
    z7  [0:3],
    z8  [0:3],
    z9  [0:3],
    z10 [0:3],
    z11 [0:3],
    z12 [0:3],
    z13 [0:3],
    z14 [0:3],
    z15 [0:3],
    z16 [0:3],
    z17 [0:3],
    tc1_ [0:3],
    tc2_ [0:3],
    tc3 [0:3],
    tc4 [0:3],
    tc5 [0:3],
    tc6 [0:3],
    tc7 [0:3],
    tc8 [0:3],
    tc9 [0:3],
    tc10[0:3],
    tc11[0:3],
    tc12[0:3],
    tc13[0:3],
    tc14[0:3],

    tc16[0:3],
    tc17[0:3],
    tc18[0:3],

    tc20[0:3],
    tc21[0:3],
    tc26[0:3];


    y14_  =![ U3 + U5];
    y13_  =![ U0 + U6];
    y9_   =![ U0 + U3];
    y8_   =![ U0 + U5];
    t0    := U1 + U2;
    y1_   =![ t0 + U7];
    y4    =![ y1_ + U3];
    y12   =![ y13_ + y14_];
    y2    =![ y1_ + U0];
    y5    =![ y1_ + U6];
    y3    =![y5 + y8_];
    t1    := U4 + y12;
    y15   =![t1 + U5];
    y20_  := t1 + U1;
    y6    =![ y15 + U7];
    y10   =![ y15 + t0];
    y11   =![ y20_ + y9_];
    y7    =![ U7 + y11];
    y17   =![ y10 + y11];
    y19   := y10 + y8_;
    y16   =![ t0 + y11];
    y21_  := y13_ + y16;
    y18   := U0 + y16;
    t2    = AND(y12, y15);
    t3_   = AND(y3, y6);
    t4_   := t3_ + t2;
    t5    = AND(y4, U7);
    t6    := t5 + t2;
    t7    = AND(y13_, y16);
    t8    = AND(y5, y1_);
    t9    := t8 + t7;
    t10_  = AND(y2, y7);
    t11_  := t10_ + t7;
    t12_  = AND(y9_, y11);
    t13_  = AND(y14_, y17);
    t14   := t13_ + t12_;
    t15   = AND(y8_, y10);
    t16   := t15 + t12_;
    t17   := t4_ + y20_;
    t18   := t6 + t16;
    t19   := t9 + t14;
    t20_  := t11_ + t16;
    t21_  =![ t17 + t14];
    t22_  := t18 + y19;
    t23_  =![ t19 + y21_];
    t24   =![ t20_ + y18];
    t25   =![ t21_ + t22_];
    t26   = AND(t21_, t23_);
    t27   =![ t24 + t26];
    t28   = AND(t25, t27);
    t29   =![ t28 + t22_];
    t30   =![ t23_ + t24];
    t31   =![ t22_ + t26];
    t32   = AND(t31, t30);
    t33   =![ t32 + t24];
    t34   := t23_ + t33;
    t35   =![ t27 + t33];
    t36   = AND(t24, t35);
    t37   =![ t36 + t34];
    t38   =![ t27 + t36];
    t39   = AND(t29, t38);
    t40   =![ t25 + t39];
    t41   =![ t40 + t37];
    t42   =![ t29 + t33];
    t43   =![ t29 + t40];
    t44   =![ t33 + t37];
    t45   =![ t42 + t41];
    z0    = AND(t44, y15);
    z1_   = AND(t37, y6);
    z2    = AND(t33, U7);
    z3    = AND(t43, y16);
    z4    = AND(t40, y1_);
    z5    = AND(t29, y7);
    z6    = AND(t42, y11);
    z7    = AND(t45, y17);
    z8    = AND(t41, y10); 
    z9    = AND(t44, y12);
    z10   = AND(t37, y3);
    z11   = AND(t33, y4);
    z12   = AND(t43, y13_);
    z13   = AND(t40, y5);
    z14   = AND(t29, y2); 
    z15   = AND(t42, y9_);
    z16   = AND(t45, y14_);
    z17   = AND(t41, y8_); 
    tc1_  := z15 + z16;
    tc2_  := z10 + tc1_;
    tc3   := z9 + tc2_;
    tc4   := z0 + z2;
    tc5   := z1_ + z0;
    tc6   := z3 + z4;
    tc7   := z12 + tc4; 
    tc8   := z7 + tc6;
    tc9   := z8 + tc7;
    tc10  := tc8 + tc9; 
    tc11  := tc6 + tc5;
    tc12  := z3 + z5;
    tc13  := z13 + tc1_;
    tc14  := tc4 + tc12; 
    S3    := tc3 + tc11;
    tc16  := z6 + tc8;
    tc17  := z14 + tc10;
    tc18  := tc13 + tc14;
    S7    := z12 + tc18; 
    tc20  := z15 + tc16;
    tc21  := tc2_ + z11; 
    S0    := tc3 + tc16;
    S6    := tc10 + tc18;
    S4    := tc14 + S3;
    S1    := S3 + tc16;
    tc26  := tc17 + tc20;
    S2    := tc26 + z17;
    S5    := tc21 + tc17; 
end

para Probing SBOX